AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Nested Stack for sam-basic

Transform:
  - AWS::Serverless-2016-10-31

Resources:
  # Using AWS::CloudFormation::Stack instead of AWS::Serverless::Application
  # to test nested stack support with native CloudFormation resource type
  NestedNestedStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: nested-nested-stack.yaml

  testTsCommonJs:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: services/testTsCommonJs/
      Handler: lambda.lambdaHandler
      Runtime: nodejs24.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 10
      Policies:
        - AWSLambdaBasicExecutionRole
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: cjs
        Minify: true
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - lambda.ts

  testTsEsModule:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: services/testTsEsModule/
      Handler: lambda.lambdaHandler
      Runtime: nodejs24.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 10
      Policies:
        - AWSLambdaBasicExecutionRole
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Format: esm
        OutExtension:
          - .js=.mjs
        Minify: true
        Target: 'es2020'
        Sourcemap: true
        Banner:
          - js=import { createRequire } from 'module'; const require = createRequire(import.meta.url);
        EntryPoints:
          - lambda.ts

  testJsCommonJs:
    Type: AWS::Serverless::Function
    Properties:
      Handler: services/testJsCommonJs/lambda.lambdaHandler
      Runtime: nodejs24.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 10
      Policies:
        - AWSLambdaBasicExecutionRole

Outputs:
  FunctionNameTestTsCommonJs:
    Value: !Ref testTsCommonJs
  FunctionNameTestTsEsModule:
    Value: !Ref testTsEsModule
  FunctionNameTestJsCommonJs:
    Value: !Ref testJsCommonJs
  # Pass through outputs from nested-nested stack
  FunctionNameTestTsCommonJsNested:
    Value: !GetAtt NestedNestedStack.Outputs.FunctionNameTestTsCommonJsNested
  FunctionNameTestTsEsModuleNested:
    Value: !GetAtt NestedNestedStack.Outputs.FunctionNameTestTsEsModuleNested
  FunctionNameTestJsCommonJsNested:
    Value: !GetAtt NestedNestedStack.Outputs.FunctionNameTestJsCommonJsNested
